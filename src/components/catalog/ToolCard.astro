---
import PlaceholderImage from './PlaceholderImage.astro';

interface Props {
  slug: string;
  title: string;
  shortDescription: string;
  coverImage: string;
  gifPreview?: string;
  priceModel: 'free' | 'freemium' | 'paid';
  priceFrom?: number;
  tags: string[];
  isNsfw: boolean;
  affiliateLink?: string;
}

const { 
  slug, title, coverImage, gifPreview, priceModel, priceFrom, tags, isNsfw
} = Astro.props;

// Формируем лейбл цены: "Бесплатно" или "от X$"
const priceLabel = priceModel === 'free' ? 'Бесплатно' : priceFrom ? `от ${priceFrom}$` : 'Бесплатно';
const needsPlaceholder = !coverImage || coverImage.trim() === '';
const primaryCategory = tags.find(t => ['chatbot', 'image-gen', 'telegram-bot', 'video'].includes(t));
---

<article class="tool-card" data-pagefind-body data-tags={tags.join(',')}>
  <a href={`/tool/${slug}`} class="tool-card__link">
    <div class="tool-card__image-wrapper">
      <div class="tool-card__image-container">
        {needsPlaceholder ? (
          <PlaceholderImage title={title} category={primaryCategory} />
        ) : (
          <img
            src={coverImage}
            alt={title}
            class:list={['tool-card__image', { 'nsfw-image': isNsfw }]}
            data-static={coverImage}
            data-gif={gifPreview}
            data-title={title}
            data-category={primaryCategory}
            loading="lazy"
            onerror="this.style.display='none';this.nextElementSibling.style.display='block';"
          />
          <div class="tool-card__placeholder-fallback" style="display:none;">
            <PlaceholderImage title={title} category={primaryCategory} />
          </div>
        )}
      </div>
    </div>

    <div class="tool-card__content">
      <h3 class="tool-card__title" data-pagefind-meta="title">{title}</h3>
      <span class="tool-card__price">{priceLabel}</span>
    </div>
  </a>
</article>

<style>
  .tool-card {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .tool-card__link {
    display: block;
    text-decoration: none;
    color: inherit;
    flex: 1;
  }

  .tool-card__link:hover {
    color: inherit;
  }

  .tool-card__image-wrapper {
    position: relative;
    aspect-ratio: 16 / 10;
    overflow: hidden;
    background: rgb(var(--ids__surface-RGB));
    border-radius: 16px;
    --mouse-x: 50%;
    --mouse-y: 50%;
    --spotlight-color: rgba(var(--ids__text-RGB), 0.25);
  }

  .tool-card__image-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(
      circle at var(--mouse-x) var(--mouse-y),
      var(--spotlight-color),
      transparent 60%
    );
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
    z-index: 10;
  }

  .tool-card__image-wrapper:hover::before {
    opacity: 1;
  }

  .tool-card__image-container {
    width: 100%;
    height: 100%;
  }

  .tool-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: filter 0.3s ease;
  }

  .tool-card__placeholder-fallback {
    width: 100%;
    height: 100%;
  }

  :global(.safe-mode) .nsfw-image {
    filter: blur(20px);
  }

  .tool-card__content {
    padding: 0.75em 0;
  }

  .tool-card__title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0 0 0.2em;
    line-height: 1.2;
    color: rgba(var(--ids__text-RGB), 0.6);
    transition: color 0.5s ease;
  }

  .tool-card:hover .tool-card__title {
    color: rgb(var(--ids__text-RGB));
    transition: color 0s ease;
  }

  .tool-card__price {
    display: block;
    font-size: 0.95em;
    color: rgba(var(--ids__text-RGB), 0.6);
    transition: color 0.5s ease;
  }

  .tool-card:hover .tool-card__price {
    color: rgb(var(--ids__text-RGB));
    transition: color 0s ease;
  }
</style>

<script>
  function initToolCardEffects() {
    // GIF preview on hover
    document.querySelectorAll('.tool-card__image[data-gif]').forEach(img => {
      const imgEl = img as HTMLImageElement;
      const staticSrc = imgEl.dataset.static;
      const gifSrc = imgEl.dataset.gif;

      if (staticSrc && gifSrc) {
        imgEl.closest('.tool-card')?.addEventListener('mouseenter', () => {
          imgEl.src = gifSrc;
        });
        imgEl.closest('.tool-card')?.addEventListener('mouseleave', () => {
          imgEl.src = staticSrc;
        });
      }
    });

    // Spotlight effect on image wrapper
    document.querySelectorAll('.tool-card__image-wrapper').forEach(wrapper => {
      wrapper.addEventListener('mousemove', (e) => {
        const rect = (wrapper as HTMLElement).getBoundingClientRect();
        const x = (e as MouseEvent).clientX - rect.left;
        const y = (e as MouseEvent).clientY - rect.top;
        (wrapper as HTMLElement).style.setProperty('--mouse-x', `${x}px`);
        (wrapper as HTMLElement).style.setProperty('--mouse-y', `${y}px`);
      });
    });
  }

  initToolCardEffects();
  document.addEventListener('astro:page-load', initToolCardEffects);
</script>
