---
import Rounded from '../Rounded.astro';
import PaymentBadges from './PaymentBadges.astro';
import AccessBadges from './AccessBadges.astro';
import PlaceholderImage from './PlaceholderImage.astro';
import { TAGS_BY_ID, PRICE_MODEL_LABELS } from '../../lib/types';

interface Props {
  slug: string;
  title: string;
  shortDescription: string;
  coverImage: string;
  gifPreview?: string;
  priceModel: 'free' | 'freemium' | 'paid';
  tags: string[];
  isNsfw: boolean;
  telegramBotLink?: string;
  acceptsRussianCards?: boolean;
  requiresVpn?: boolean;
  supportsRussian?: boolean;
  paymentMethods?: string[];
}

const { 
  slug, title, shortDescription, coverImage, gifPreview, priceModel, tags, isNsfw, telegramBotLink,
  acceptsRussianCards = false, requiresVpn = true, supportsRussian = false, paymentMethods = []
} = Astro.props;

const priceLabel = PRICE_MODEL_LABELS[priceModel];
const isTelegramBot = tags.includes('telegram-bot');
const displayTags = tags.slice(0, 3).map(id => TAGS_BY_ID[id]?.label || id);

// Check if we need placeholder
const needsPlaceholder = !coverImage || coverImage.trim() === '';
const primaryCategory = tags.find(t => ['chatbot', 'image-gen', 'telegram-bot', 'video'].includes(t));
---

<article class="tool-card" data-pagefind-body>
  <a href={`/tool/${slug}`} class="tool-card__link">
    <Rounded radius="1em" class="tool-card__image-wrapper">
      <div class="tool-card__image-container">
        {needsPlaceholder ? (
          <PlaceholderImage title={title} category={primaryCategory} />
        ) : (
          <img
            src={coverImage}
            alt={title}
            class:list={['tool-card__image', { 'nsfw-image': isNsfw }]}
            data-static={coverImage}
            data-gif={gifPreview}
            data-title={title}
            data-category={primaryCategory}
            loading="lazy"
            onerror="this.style.display='none';this.nextElementSibling.style.display='block';"
          />
          <div class="tool-card__placeholder-fallback" style="display:none;">
            <PlaceholderImage title={title} category={primaryCategory} />
          </div>
        )}
      </div>
      <span class:list={['tool-card__badge', `tool-card__badge--${priceModel}`]}>
        {priceLabel}
      </span>
    </Rounded>

    <div class="tool-card__content">
      <h3 class="tool-card__title" data-pagefind-meta="title">{title}</h3>
      <p class="tool-card__description" data-pagefind-meta="description">{shortDescription}</p>
      <div class="tool-card__tags" data-pagefind-filter="tags">
        {displayTags.map(tag => (
          <span class="tool-card__tag">{tag}</span>
        ))}
      </div>
      
      <div class="tool-card__badges">
        <PaymentBadges 
          acceptsRussianCards={acceptsRussianCards} 
          paymentMethods={paymentMethods} 
          priceModel={priceModel}
          compact
        />
        <AccessBadges 
          requiresVpn={requiresVpn} 
          supportsRussian={supportsRussian}
          compact
        />
      </div>
    </div>
  </a>

  {isTelegramBot && telegramBotLink && (
    <a href={telegramBotLink} class="tool-card__telegram-link" target="_blank" rel="noopener">
      Открыть в Telegram →
    </a>
  )}
</article>

<style>
  .tool-card {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .tool-card__link {
    display: block;
    text-decoration: none;
    color: inherit;
    flex: 1;
  }

  .tool-card__image-wrapper {
    position: relative;
    aspect-ratio: 16 / 10;
    overflow: hidden;
    background: rgb(var(--ids__surface-RGB));
  }

  .tool-card__image-container {
    width: 100%;
    height: 100%;
  }

  .tool-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease, filter 0.3s ease;
  }

  .tool-card:hover .tool-card__image {
    transform: scale(1.05);
  }

  .tool-card__placeholder-fallback {
    width: 100%;
    height: 100%;
  }

  /* Safe Mode blur */
  :global(.safe-mode) .nsfw-image {
    filter: blur(20px);
  }

  .tool-card__badge {
    position: absolute;
    top: 0.5em;
    right: 0.5em;
    padding: 0.3em 0.7em;
    font-size: 0.85em;
    font-weight: 500;
    border-radius: 0.3em;
    background: rgba(0, 0, 0, 0.7);
    color: white;
  }

  .tool-card__badge--free {
    background: rgba(0, 150, 0, 0.9);
  }

  .tool-card__badge--freemium {
    background: rgba(0, 100, 200, 0.9);
  }

  .tool-card__badge--paid {
    background: rgba(200, 100, 0, 0.9);
  }

  .tool-card__content {
    padding: 0.75em 0;
  }

  .tool-card__title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0 0 0.3em;
    line-height: 1.2;
  }

  .tool-card__description {
    font-size: 0.85em;
    opacity: 0.8;
    margin: 0 0 0.5em;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tool-card__tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3em;
  }

  .tool-card__tag {
    font-size: 0.85em;
    padding: 0.3em 0.7em;
    background: rgb(var(--ids__surface-RGB));
    border-radius: 0.3em;
    opacity: 0.8;
  }

  .tool-card__badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3em;
    margin-top: 0.5em;
  }

  .tool-card__telegram-link {
    display: inline-block;
    font-size: 0.85em;
    padding: 0.4em 0.8em;
    background: #0088cc;
    color: white;
    border-radius: 0.3em;
    text-decoration: none;
    margin-top: 0.5em;
    transition: background 0.2s;
  }

  .tool-card__telegram-link:hover {
    background: #006699;
    color: white;
  }
</style>

<script>
  // GIF preview on hover
  document.querySelectorAll('.tool-card__image[data-gif]').forEach(img => {
    const imgEl = img as HTMLImageElement;
    const staticSrc = imgEl.dataset.static;
    const gifSrc = imgEl.dataset.gif;

    if (staticSrc && gifSrc) {
      imgEl.closest('.tool-card')?.addEventListener('mouseenter', () => {
        imgEl.src = gifSrc;
      });
      imgEl.closest('.tool-card')?.addEventListener('mouseleave', () => {
        imgEl.src = staticSrc;
      });
    }
  });
</script>
