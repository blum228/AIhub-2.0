---
import Rounded from '../Rounded.astro';
import PlaceholderImage from './PlaceholderImage.astro';
import { PRICE_MODEL_LABELS } from '../../lib/types';

interface Props {
  slug: string;
  title: string;
  shortDescription: string;
  coverImage: string;
  gifPreview?: string;
  priceModel: 'free' | 'freemium' | 'paid';
  tags: string[];
  isNsfw: boolean;
  affiliateLink?: string;
}

const { 
  slug, title, coverImage, gifPreview, priceModel, tags, isNsfw, affiliateLink
} = Astro.props;

const priceLabel = PRICE_MODEL_LABELS[priceModel];
const needsPlaceholder = !coverImage || coverImage.trim() === '';
const primaryCategory = tags.find(t => ['chatbot', 'image-gen', 'telegram-bot', 'video'].includes(t));

// Извлекаем домен из affiliateLink для отображения
const siteUrl = affiliateLink ? new URL(affiliateLink).hostname.replace('www.', '').toUpperCase() : '';
---

<article class="tool-card" data-pagefind-body data-tags={tags.join(',')}>
  <a href={`/tool/${slug}`} class="tool-card__link">
    <Rounded class="tool-card__image-wrapper">
      <div class="tool-card__image-container">
        {needsPlaceholder ? (
          <PlaceholderImage title={title} category={primaryCategory} />
        ) : (
          <img
            src={coverImage}
            alt={title}
            class:list={['tool-card__image', { 'nsfw-image': isNsfw }]}
            data-static={coverImage}
            data-gif={gifPreview}
            data-title={title}
            data-category={primaryCategory}
            loading="lazy"
            onerror="this.style.display='none';this.nextElementSibling.style.display='block';"
          />
          <div class="tool-card__placeholder-fallback" style="display:none;">
            <PlaceholderImage title={title} category={primaryCategory} />
          </div>
        )}
      </div>
    </Rounded>

    <div class="tool-card__content">
      <h3 class="tool-card__title" data-pagefind-meta="title">{title}</h3>
      {siteUrl && <span class="tool-card__site">{siteUrl}</span>}
      <span class="tool-card__price">{priceLabel}</span>
    </div>
  </a>
</article>

<style>
  .tool-card {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .tool-card__link {
    display: block;
    text-decoration: none;
    color: inherit;
    flex: 1;
  }

  .tool-card__image-wrapper {
    position: relative;
    aspect-ratio: 16 / 10;
    overflow: hidden;
    background: rgb(var(--ids__surface-RGB));
  }

  .tool-card__image-container {
    width: 100%;
    height: 100%;
  }

  .tool-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: filter 0.3s ease;
  }

  .tool-card__placeholder-fallback {
    width: 100%;
    height: 100%;
  }

  :global(.safe-mode) .nsfw-image {
    filter: blur(20px);
  }

  .tool-card__content {
    padding: 0.75em 0;
  }

  .tool-card__title {
    font-size: 1.1em;
    font-weight: 600;
    margin: 0 0 0.2em;
    line-height: 1.2;
    transition: color 0.2s ease;
  }

  .tool-card:hover .tool-card__title {
    color: rgb(var(--ids__link-RGB));
  }

  .tool-card__site {
    display: block;
    font-size: 0.75em;
    opacity: 0.6;
    margin-bottom: 0.3em;
    letter-spacing: 0.02em;
  }

  .tool-card__price {
    display: block;
    font-size: 0.95em;
    font-weight: 500;
  }
</style>

<script>
  document.querySelectorAll('.tool-card__image[data-gif]').forEach(img => {
    const imgEl = img as HTMLImageElement;
    const staticSrc = imgEl.dataset.static;
    const gifSrc = imgEl.dataset.gif;

    if (staticSrc && gifSrc) {
      imgEl.closest('.tool-card')?.addEventListener('mouseenter', () => {
        imgEl.src = gifSrc;
      });
      imgEl.closest('.tool-card')?.addEventListener('mouseleave', () => {
        imgEl.src = staticSrc;
      });
    }
  });
</script>
