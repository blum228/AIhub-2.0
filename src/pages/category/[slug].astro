---
import { getCollection } from 'astro:content';
import CatalogLayout from '../../layouts/CatalogLayout.astro';
import ToolGrid from '../../components/catalog/ToolGrid.astro';
import CategoryCard from '../../components/catalog/CategoryCard.astro';
import Breadcrumbs from '../../components/catalog/Breadcrumbs.astro';
import ComparisonTable from '../../components/catalog/ComparisonTable.astro';
import Space from '../../components/Space.astro';
import TextWidth from '../../components/TextWidth.astro';
import { getToolsForCollection, getToolCountForCollection, sortCollectionsByOrder } from '../../lib/collections';
import { sortToolsByRating } from '../../lib/tools';
import type { ToolData } from '../../lib/types';
import type { CollectionData } from '../../lib/collections';

export async function getStaticPaths() {
  const collectionsEntries = await getCollection('collections');
  
  return collectionsEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { collection: entry }
  }));
}

const { collection } = Astro.props;
const { slug } = Astro.params;

// Get all collections for sidebar
const collectionsEntries = await getCollection('collections');
const allCollections: CollectionData[] = sortCollectionsByOrder(
  collectionsEntries.map(entry => ({
    slug: entry.slug,
    ...entry.data
  }))
);

// Current collection data
const currentCollection: CollectionData = {
  slug: collection.slug,
  ...collection.data
};

// Get all tools
const toolsCollection = await getCollection('tools');
const allTools: ToolData[] = toolsCollection.map(entry => ({
  slug: entry.slug,
  ...entry.data
}));

// Filter tools for this collection
const filteredTools = sortToolsByRating(
  getToolsForCollection(allTools, currentCollection)
);

// Other collections for sidebar
const otherCollections = allCollections.filter(c => c.slug !== slug);

// Breadcrumbs
const breadcrumbItems = [
  { label: 'Каталог', href: '/catalog' },
  { label: currentCollection.title }
];

// Render collection content
const { Content } = await collection.render();

// Schema.org CollectionPage
const siteUrl = Astro.site?.toString() || 'https://ai-catalog.ru';
const pageUrl = `${siteUrl}/category/${slug}`;

const collectionPageSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": currentCollection.title,
  "description": currentCollection.seoDescription,
  "url": pageUrl,
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": filteredTools.length,
    "itemListElement": filteredTools.map((tool, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": `${siteUrl}/tool/${tool.slug}`,
      "name": tool.title
    }))
  }
};
---

<CatalogLayout
  title={`${currentCollection.title} — AI Каталог`}
  description={currentCollection.seoDescription}
>
  <script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />
  
  <Breadcrumbs items={breadcrumbItems} />
  
  <Space size="S" />

  <header class="category-header">
    <span class="category-header__icon">{currentCollection.icon}</span>
    <div class="category-header__content">
      <h1 class="category-header__title">{currentCollection.title}</h1>
      <p class="category-header__description">{currentCollection.description}</p>
      <span class="category-header__count">{filteredTools.length} сервисов</span>
    </div>
  </header>

  <Space size="M" />

  <main>
    {filteredTools.length > 0 ? (
      <ToolGrid tools={filteredTools} />
    ) : (
      <aside class="category-empty">
        <p>В этой категории пока нет сервисов.</p>
      </aside>
    )}

    <Space size="L" />

    <!-- Comparison Table -->
    {filteredTools.length > 1 && (
      <ComparisonTable tools={filteredTools} />
    )}

    <Space size="L" />

    <TextWidth>
      <section class="category-content">
        <Content />
      </section>
    </TextWidth>

    <Space size="L" />

    <aside>
      <h3 class="sidebar-title">Другие категории</h3>
      <div class="sidebar-categories">
        {otherCollections.map(col => (
          <CategoryCard
            slug={col.slug}
            title={col.title}
            description={col.description}
            icon={col.icon}
            toolCount={getToolCountForCollection(allTools, col)}
          />
        ))}
      </div>
    </aside>
  </main>
</CatalogLayout>

<style>
  .category-header {
    display: flex;
    align-items: flex-start;
    gap: 1em;
  }

  .category-header__icon {
    font-size: 3em;
    line-height: 1;
  }

  .category-header__content {
    flex: 1;
  }

  .category-header__title {
    margin: 0 0 0.3em;
    line-height: 1.2;
  }

  .category-header__description {
    opacity: 0.8;
    margin: 0 0 0.5em;
    line-height: 1.4;
  }

  .category-header__count {
    display: inline-block;
    font-size: 0.9em;
    padding: 0.3em 0.8em;
    background: rgb(var(--ids__surface-RGB));
    border-radius: var(--ids__radius);
    opacity: 0.8;
  }

  .category-empty {
    padding: 3em;
    opacity: 0.7;
  }

  .sidebar-title {
    font-size: 1em;
    margin: 0 0 1em;
    opacity: 0.7;
  }

  .sidebar-categories {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75em;
  }

  @media (max-width: 767px) {
    .category-header__icon {
      font-size: 2em;
    }
  }
</style>
