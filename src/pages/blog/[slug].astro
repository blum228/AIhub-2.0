---
/**
 * Страница отдельного блог-поста
 * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6
 */
import { getCollection } from 'astro:content';
import CatalogLayout from '../../layouts/CatalogLayout.astro';
import Rounded from '../../components/Rounded.astro';
import Space from '../../components/Space.astro';
import TextWidth from '../../components/TextWidth.astro';
import Breadcrumbs from '../../components/catalog/Breadcrumbs.astro';
import ToolCard from '../../components/catalog/ToolCard.astro';
import Sequence from '../../components/Sequence.astro';
import SequenceItem from '../../components/SequenceItem.astro';
import { calculateReadingTime } from '../../lib/blog';
import type { ToolData } from '../../lib/types';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(entry => ({
    params: { slug: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const { title, description, publishedAt, author, coverImage, relatedTools, tags } = entry.data;

// Время чтения (используем body контента)
const readingTime = calculateReadingTime(entry.body);

// Форматирование даты
const formattedDate = publishedAt.toLocaleDateString('ru-RU', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Breadcrumbs
const breadcrumbItems = [
  { label: 'Блог', href: '/blog' },
  { label: title }
];

// Related tools
let relatedToolsData: ToolData[] = [];
if (relatedTools && relatedTools.length > 0) {
  const allTools = await getCollection('tools');
  relatedToolsData = relatedTools
    .map(slug => allTools.find(t => t.slug === slug))
    .filter((t): t is NonNullable<typeof t> => t !== undefined)
    .map(t => ({ slug: t.slug, ...t.data }));
}

// Schema.org Article
const siteUrl = Astro.site?.toString() || 'https://ai-catalog.ru';
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "datePublished": publishedAt.toISOString(),
  "author": {
    "@type": "Person",
    "name": author
  },
  "publisher": {
    "@type": "Organization",
    "name": "AI Каталог СНГ",
    "url": siteUrl
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `${siteUrl}/blog/${entry.slug}`
  },
  ...(coverImage && { "image": `${siteUrl}${coverImage}` })
};

// Breadcrumb Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Главная", "item": siteUrl },
    { "@type": "ListItem", "position": 2, "name": "Блог", "item": `${siteUrl}/blog` },
    { "@type": "ListItem", "position": 3, "name": title }
  ]
};
---

<CatalogLayout
  title={title}
  description={description}
  ogImage={coverImage}
>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <Breadcrumbs items={breadcrumbItems} />
  <Space size="S" />

  <article class="blog-post">
    <!-- Header -->
    <header class="blog-post__header">
      {coverImage && (
        <Rounded class="blog-post__cover">
          <img 
            src={coverImage} 
            alt={title} 
            class="blog-post__image" 
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <div class="blog-post__placeholder" style="display: none;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </div>
        </Rounded>
      )}

      <Space size="M" />

      <TextWidth>
        <h1>{title}</h1>
        
        <p class="blog-post__meta">
          <time datetime={publishedAt.toISOString()}>{formattedDate}</time> · {author} · {readingTime} мин. чтения
        </p>

        {tags && tags.length > 0 && (
          <p>{tags.join(' · ')}</p>
        )}
      </TextWidth>
    </header>

    <Space size="L" />

    <!-- Content -->
    <TextWidth>
      <div class="blog-post__content prose">
        <Content />
      </div>
    </TextWidth>

    <!-- Related Tools -->
    {relatedToolsData.length > 0 && (
      <>
        <Space size="L" />
        <section class="blog-post__related">
          <h2>Упомянутые инструменты</h2>
          <Space size="S" />
          <Sequence size="L" gap="M">
            {relatedToolsData.map(tool => (
              <SequenceItem>
                <ToolCard
                  slug={tool.slug}
                  title={tool.title}
                  shortDescription={tool.shortDescription}
                  coverImage={tool.coverImage}
                  gifPreview={tool.gifPreview}
                  priceModel={tool.priceModel}
                  tags={tool.tags}
                  isNsfw={tool.isNsfw}
                  affiliateLink={tool.affiliateLink}
                />
              </SequenceItem>
            ))}
          </Sequence>
        </section>
      </>
    )}
  </article>
</CatalogLayout>

<style>
  .blog-post__cover {
    max-width: 800px;
    overflow: hidden;
  }

  .blog-post__image {
    width: 100%;
    height: auto;
    display: block;
  }

  .blog-post__meta {
    opacity: 0.7;
  }

  .blog-post__placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    aspect-ratio: 16 / 9;
    background: rgba(var(--ids__text-RGB), 0.05);
    color: rgba(var(--ids__text-RGB), 0.3);
  }

  .blog-post__content {
    line-height: 1.7;
  }

  .blog-post__content :global(h2) {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
  }

  .blog-post__content :global(p) {
    margin-bottom: 1em;
  }

  .blog-post__content :global(ul),
  .blog-post__content :global(ol) {
    margin-bottom: 1em;
    padding-left: 1.5em;
  }

  .blog-post__content :global(li) {
    margin-bottom: 0.3em;
  }
</style>
