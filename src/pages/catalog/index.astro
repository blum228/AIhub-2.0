---
import { getCollection } from 'astro:content';
import CatalogLayout from '../../layouts/CatalogLayout.astro';
import SearchWidget from '../../components/catalog/SearchWidget.astro';
import TagFilter from '../../components/catalog/TagFilter.astro';
import ToolGrid from '../../components/catalog/ToolGrid.astro';
import CategoryCard from '../../components/catalog/CategoryCard.astro';
import Space from '../../components/Space.astro';
import TextWidth from '../../components/TextWidth.astro';
import Sequence from '../../components/Sequence.astro';
import SequenceItem from '../../components/SequenceItem.astro';
import Rounded from '../../components/Rounded.astro';
import { sortToolsByRating } from '../../lib/tools';
import { getToolCountForCollection, sortCollectionsByOrder } from '../../lib/collections';
import type { ToolData } from '../../lib/types';
import type { CollectionData } from '../../lib/collections';

// Получаем все инструменты
const toolsCollection = await getCollection('tools');

// Преобразуем в ToolData
const tools: ToolData[] = toolsCollection.map(entry => ({
  slug: entry.slug,
  ...entry.data
}));

// Сортируем по рейтингу
const sortedTools = sortToolsByRating(tools);

// Получаем коллекции
const collectionsEntries = await getCollection('collections');
const collections: CollectionData[] = sortCollectionsByOrder(
  collectionsEntries.map(entry => ({
    slug: entry.slug,
    ...entry.data
  }))
);

// Выделяем Telegram боты для featured секции
const telegramBots = sortedTools.filter(t => t.tags.includes('telegram-bot')).slice(0, 4);
---

<CatalogLayout
  title="Каталог AI-сервисов"
  description="Лучшие AI-сервисы для ролеплея и генерации контента 18+. Фильтры по оплате, языку и доступности из России."
>
  <!-- Hero -->
  <TextWidth>
    <Space size="XL" />
    <h1 class="S">AI Каталог для СНГ</h1>
    <p class="loud">
      Лучшие AI-сервисы для ролеплея и генерации контента.<br />
      Фильтры по оплате картами РФ, поддержке русского языка и доступности без VPN.
    </p>
    <SearchWidget placeholder="Поиск по названию или описанию..." />
  </TextWidth>

  <Space size="L" />

  <!-- Категории -->
  <h2>Категории</h2>
  <Space size="S" />
  <Sequence size="L" gap="M">
    {collections.map(col => (
      <SequenceItem>
        <CategoryCard
          slug={col.slug}
          title={col.title}
          description={col.description}
          icon={col.icon}
          toolCount={getToolCountForCollection(tools, col)}
        />
      </SequenceItem>
    ))}
  </Sequence>

  <Space size="L" />

  <!-- Фильтры -->
  <TagFilter />

  <Space size="M" />

  <!-- Основная сетка -->
  <h2>Все сервисы</h2>
  <Space size="S" />
  <ToolGrid tools={sortedTools} />

  <!-- Featured: Telegram боты -->
  {telegramBots.length > 0 && (
    <>
      <Space size="L" />
      <Rounded radius="1em">
        <aside>
          <Sequence size="XL" gap="S">
            <SequenceItem>
              <h3>Telegram боты</h3>
            </SequenceItem>
            <SequenceItem>
              <a href="/telegram-bots">Все боты</a>
            </SequenceItem>
          </Sequence>
          <Space size="S" />
          <ToolGrid tools={telegramBots} />
        </aside>
      </Rounded>
    </>
  )}
</CatalogLayout>
