---
import { getCollection } from 'astro:content';
import CatalogLayout from '../../layouts/CatalogLayout.astro';
import SearchWidget from '../../components/catalog/SearchWidget.astro';
import TagFilter from '../../components/catalog/TagFilter.astro';
import ToolGrid from '../../components/catalog/ToolGrid.astro';
import CategoryCard from '../../components/catalog/CategoryCard.astro';
import Space from '../../components/Space.astro';
import TextWidth from '../../components/TextWidth.astro';
import Sequence from '../../components/Sequence.astro';
import SequenceItem from '../../components/SequenceItem.astro';
import { sortToolsByRating, filterToolsByTags } from '../../lib/tools';
import { getToolCountForCollection, sortCollectionsByOrder } from '../../lib/collections';
import type { ToolData } from '../../lib/types';
import type { CollectionData } from '../../lib/collections';

// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
const toolsCollection = await getCollection('tools');

// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ ToolData
const tools: ToolData[] = toolsCollection.map(entry => ({
  slug: entry.slug,
  ...entry.data
}));

// –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
const sortedTools = sortToolsByRating(tools);

// –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏–∏
const collectionsEntries = await getCollection('collections');
const collections: CollectionData[] = sortCollectionsByOrder(
  collectionsEntries.map(entry => ({
    slug: entry.slug,
    ...entry.data
  }))
);

// –í—ã–¥–µ–ª—è–µ–º Telegram –±–æ—Ç—ã –¥–ª—è featured —Å–µ–∫—Ü–∏–∏
const telegramBots = sortedTools.filter(t => t.tags.includes('telegram-bot')).slice(0, 4);
---

<CatalogLayout
  title="–ö–∞—Ç–∞–ª–æ–≥ AI-—Å–µ—Ä–≤–∏—Å–æ–≤"
  description="–õ—É—á—à–∏–µ AI-—Å–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ä–æ–ª–µ–ø–ª–µ—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ 18+. –§–∏–ª—å—Ç—Ä—ã –ø–æ –æ–ø–ª–∞—Ç–µ, —è–∑—ã–∫—É –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–∑ –†–æ—Å—Å–∏–∏."
>
  <!-- Hero -->
  <TextWidth>
    <Space size="XL" />
    <h1 class="S">AI –ö–∞—Ç–∞–ª–æ–≥ –¥–ª—è –°–ù–ì</h1>
    <p class="loud">
      –õ—É—á—à–∏–µ AI-—Å–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ä–æ–ª–µ–ø–ª–µ—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.<br />
      –§–∏–ª—å—Ç—Ä—ã –ø–æ –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–∞–º–∏ –†–§, –ø–æ–¥–¥–µ—Ä–∂–∫–µ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–µ–∑ VPN.
    </p>
    <SearchWidget placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..." />
  </TextWidth>

  <Space size="L" />

  <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
  <Space size="S" />
  <Sequence size="L" gap="M">
    {collections.map(col => (
      <SequenceItem>
        <CategoryCard
          slug={col.slug}
          title={col.title}
          description={col.description}
          icon={col.icon}
          toolCount={getToolCountForCollection(tools, col)}
        />
      </SequenceItem>
    ))}
  </Sequence>

  <Space size="L" />

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <TagFilter />

  <Space size="M" />

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ -->
  <h2>–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã</h2>
  <Space size="S" />
  <ToolGrid tools={sortedTools} />

  <!-- Featured: Telegram –±–æ—Ç—ã -->
  {telegramBots.length > 0 && (
    <>
      <Space size="L" />
      <section class="featured-section">
        <h2 class="featured-title">
          <span>ü§ñ</span> Telegram –±–æ—Ç—ã
          <a href="/telegram-bots" class="featured-link">–í—Å–µ –±–æ—Ç—ã ‚Üí</a>
        </h2>
        <Space size="S" />
        <ToolGrid tools={telegramBots} />
      </section>
    </>
  )}
</CatalogLayout>

<style>
  .featured-section {
    padding: calc(var(--ids__density) * 1em);
    background: rgb(var(--ids__surface-RGB));
    border-radius: var(--ids__radius);
  }

  .featured-title {
    display: flex;
    align-items: center;
    gap: 0.5em;
  }

  .featured-link {
    margin-left: auto;
    font-size: 0.5em;
    font-weight: normal;
    color: rgb(var(--ids__link-RGB));
  }

  .featured-link:hover {
    color: rgb(var(--ids__hover-RGB));
  }
</style>
